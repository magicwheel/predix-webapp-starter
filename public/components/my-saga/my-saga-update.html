<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/components/my-api/my-api.html" />

<dom-module id="my-saga-update">
    <template>
        <my-api id="api" limit="0" type="min"></my-api>
        <my-api id="api2" limit="3" type="max"></my-api>
        <content></content>
    </template>
</dom-module>

<!-- Registers custom element -->
<script>
    Polymer({
        is: 'my-saga-update',

        getSaga: function(taskPromise){
            let me = this;
            const sagaParent = $(me).closest('my-saga')[0];

            taskPromise.then(
                    function(task){
                        sagaParent.updateStatusOnTaskDone(task);
                    }
            );

            function* incOrDec(ACTION_TYPE) { // 'INCREMENT' or 'DECREMENT'
                try {
                    sagaParent.setStatus("Handling action: " + ACTION_TYPE, 'yellow');

                    // get current counter value from store
                    const currentCounterValue = yield ReduxSaga.effects.select()

                    // dispatch action 'LOAD_START'
                    yield ReduxSaga.effects.put({type: 'LOAD_START'})


                    ////////////////////////////////////////
                    //
                    //  OPTIMISTIC
                    //
                    ////////////////////////////////////////

                    // update value
                    yield ReduxSaga.effects.put({type: ACTION_TYPE})

                    const newValue = ('INCREMENT' == ACTION_TYPE) ? currentCounterValue.value + 1 : currentCounterValue.value -1

                    // get approval string from API
                    var approvalString = yield ReduxSaga.effects.call(
                            me.$.api.signCounterChange.bind(me.$.api),
                            newValue
                    )

                    // get approval string from API2
                    approvalString = yield ReduxSaga.effects.call(
                            me.$.api2.signCounterChange.bind(me.$.api2),
                            newValue
                    )

                    // load finished
                    yield ReduxSaga.effects.put({type: 'LOAD_FINISHED', approvalString: approvalString})

                    sagaParent.setStatus("Succeeded action: " + ACTION_TYPE, 'green');

                    // relax
                    yield ReduxSaga.effects.put({type: 'SET_MESSAGE_TYPE', messagetype: 'healthy'})
                }catch(e){

                    ////////////////////////////////////////
                    //
                    //  ROLLBACK
                    //
                    ////////////////////////////////////////

                    // rollback
                    yield ReduxSaga.effects.put({type: 'ROLLBACK'})

                    // alert
                    yield ReduxSaga.effects.put({type: 'SET_MESSAGE_TYPE', messagetype: 'important'})
                    yield ReduxSaga.effects.put({type: 'LOAD_FINISHED', approvalString: e})

                    sagaParent.setStatus("Failed action: " + ACTION_TYPE, 'red');

                }
            }

            return function* counterSaga() {
                sagaParent.setStatus("Waiting for 'INCREMENT' or 'DECREMENT' actions", 'yellow');

                yield ReduxSaga.effects.takeEvery('INCREMENT_INIT', incOrDec, 'INCREMENT')
                yield ReduxSaga.effects.takeEvery('DECREMENT_INIT', incOrDec, 'DECREMENT')
            }
        }
    });

</script>
